<div class="topbar">
<div class="topbar-left">
    <h1><i class="bi bi-person-badge-fill me-2" style="color:var(--primary)"></i>Usuarios</h1>
    <p>Gestión de cuentas y roles del sistema</p>
</div>
<div class="topbar-right"><div class="avatar">A</div></div>
</div>

<div class="page-body">
<div class="table-card">
    <div class="table-card-header">
    <h2>Registro de Usuarios</h2>
    <div class="d-flex gap-2 align-items-center">
        <div class="search-box">
        <i class="bi bi-search"></i>
        <input type="text" placeholder="Buscar usuario..."
                [(ngModel)]="busqueda" (input)="buscar()">
        </div>
        <button type="button" class="btn-primary-gs1" (click)="abrirCrear()">
        <i class="bi bi-plus-lg"></i> Nuevo Usuario
        </button>
    </div>
    </div>

    <div *ngIf="loading" class="empty-state">
    <i class="bi bi-arrow-repeat"></i><h3>Cargando...</h3>
    </div>
    <div *ngIf="!loading && filtrados.length === 0" class="empty-state">
    <i class="bi bi-people"></i>
    <h3>Sin usuarios registrados</h3>
    </div>

    <div *ngIf="!loading && filtrados.length > 0" class="table-responsive">
    <table class="table">
        <thead>
        <tr>
            <th>Usuario</th>
            <th>Correo</th>
            <th>Rol</th>
            <th>Estado</th>
            <th>Registro</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let u of filtrados">
            <td>
            <div class="d-flex align-items-center gap-2">
                <div class="avatar" style="width:32px;height:32px;font-size:13px">
                {{ getInicial(u.nombre) }}
                </div>
                <strong>{{ u.nombre }} {{ u.apellido }}</strong>
            </div>
            </td>
            <td>{{ u.correo }}</td>
            <td>
            <span class="badge-gs1" [ngClass]="getRolClass(u.rol)">
                {{ u.rol | titlecase }}
            </span>
            </td>
            <td>
            <span class="badge-gs1" [ngClass]="u.activo ? 'badge-success' : 'badge-danger'">
                {{ u.activo ? 'Activo' : 'Inactivo' }}
            </span>
            </td>
            <td>{{ u.fecha_registro | date:'dd/MM/yyyy' }}</td>
            <td>
            <div class="d-flex gap-1">
                <button type="button" class="btn-icon edit" (click)="abrirEditar(u)">
                <i class="bi bi-pencil-fill"></i>
                </button>
                <button type="button" class="btn-icon delete" (click)="confirmarEliminar(u._id)">
                <i class="bi bi-person-x-fill"></i>
                </button>
            </div>
            </td>
        </tr>
        </tbody>
    </table>
    </div>
</div>
</div>

<!-- Modal -->
<div *ngIf="modalVisible" class="modal d-block modal-gs1" tabindex="-1"
    style="background:rgba(0,0,0,.4)">
<div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
    <div class="modal-header">
        <h5 class="modal-title">
        <i class="bi bi-person-fill me-2"></i>
        {{ modoEdicion ? 'Editar Usuario' : 'Nuevo Usuario' }}
        </h5>
        <button type="button" class="btn-icon" (click)="modalVisible = false">
        <i class="bi bi-x-lg"></i>
        </button>
    </div>
    <div class="modal-body p-4">
        <div class="row g-3">
        <div class="col-md-6">
            <label class="form-label-gs1">Nombre *</label>
            <input class="form-control-gs1" [(ngModel)]="form.nombre">
        </div>
        <div class="col-md-6">
            <label class="form-label-gs1">Apellido *</label>
            <input class="form-control-gs1" [(ngModel)]="form.apellido">
        </div>
        <div class="col-12">
            <label class="form-label-gs1">Correo *</label>
            <input type="email" class="form-control-gs1" [(ngModel)]="form.correo">
        </div>
        <div class="col-12">
            <label class="form-label-gs1">
            Contraseña {{ modoEdicion ? '(dejar vacío para no cambiar)' : '*' }}
            </label>
            <input type="password" class="form-control-gs1" [(ngModel)]="form.contrasena">
        </div>
        <div class="col-12">
            <label class="form-label-gs1">Rol *</label>
            <select class="form-control-gs1" [(ngModel)]="form.rol">
            <option value="admin">Admin — Acceso total</option>
            <option value="operador">Operador — Gestión de datos</option>
            <option value="consulta">Consulta — Solo lectura</option>
            </select>
        </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn-ghost" (click)="modalVisible = false">
        <i class="bi bi-x"></i> Cancelar
        </button>
        <button type="button" class="btn-primary-gs1" (click)="guardar()">
        <i class="bi bi-check-lg"></i>
        {{ modoEdicion ? 'Guardar Cambios' : 'Crear Usuario' }}
        </button>
    </div>
    </div>
</div>
</div>

<!-- Confirmar -->
<div *ngIf="confirmVisible" class="modal d-block modal-gs1" tabindex="-1"
    style="background:rgba(0,0,0,.4)">
<div class="modal-dialog modal-sm">
    <div class="modal-content">
    <div class="modal-header">
        <h5 class="modal-title text-danger">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>Confirmar
        </h5>
    </div>
    <div class="modal-body p-4"><p>¿Desactivar este usuario del sistema?</p></div>
    <div class="modal-footer">
        <button type="button" class="btn-ghost" (click)="confirmVisible = false">Cancelar</button>
        <button type="button" class="btn-primary-gs1" style="background:var(--danger)" (click)="eliminar()">
        <i class="bi bi-person-x-fill"></i> Desactivar
        </button>
    </div>
    </div>
</div>
</div>

<div *ngIf="toast.visible" class="toast-gs1"
    [style.background]="toast.tipo === 'error' ? '#e02424' : '#111827'">
<i class="bi" [ngClass]="toast.tipo === 'error' ? 'bi-x-circle-fill' : 'bi-check-circle-fill'"></i>
{{ toast.mensaje }}
</div>