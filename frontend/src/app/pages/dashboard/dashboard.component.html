<!-- ── TOPBAR ─────────────────────────────────────────── -->
<div class="topbar">
<div class="topbar-left">
    <h1>Dashboard</h1>
    <p>{{ fechaHoy | date:'EEEE, d \'de\' MMMM \'de\' yyyy' : '' : 'es' }} — Sistema GS1</p>
</div>
<div class="topbar-right">
    <div class="avatar">A</div>
</div>
</div>

<!-- ── BODY ───────────────────────────────────────────── -->
<div class="page-body">

<!-- Banner de carga global -->
<div *ngIf="!todosCargados" class="dash-loading-banner">
    <div class="spinner"></div>
    <span>Cargando datos del sistema...</span>
</div>

<!-- ── FILA 1: Stats principales ──────────────────── -->
<div class="row g-3 mb-4">

    <div class="col-sm-6 col-xl-3">
    <div class="card-stat">
        <div class="stat-icon icon-blue">
        <i class="bi bi-people-fill"></i>
        </div>
        <div class="stat-info">
        <h3>{{ stats.habitantes }}</h3>
        <p>Habitantes registrados</p>
        <div class="stat-sub">
            <i class="bi bi-house-fill"></i>
            {{ stats.habitantesJefes }} jefes de familia
        </div>
        </div>
    </div>
    </div>

    <div class="col-sm-6 col-xl-3">
    <div class="card-stat">
        <div class="stat-icon icon-green">
        <i class="bi bi-box-seam-fill"></i>
        </div>
        <div class="stat-info">
        <h3>{{ stats.ayudas }}</h3>
        <p>Ayudas disponibles</p>
        <div class="stat-sub">
            <i class="bi bi-exclamation-circle-fill" style="color:#e02424"></i>
            {{ stats.ayudasAlta }} de prioridad alta
        </div>
        </div>
    </div>
    </div>

    <div class="col-sm-6 col-xl-3">
    <div class="card-stat">
        <div class="stat-icon icon-purple">
        <i class="bi bi-calendar-event-fill"></i>
        </div>
        <div class="stat-info">
        <h3>{{ stats.jornadas }}</h3>
        <p>Jornadas y eventos</p>
        <div class="stat-sub">
            <i class="bi bi-clock-fill" style="color:#7e22ce"></i>
            {{ stats.jornadasProgramadas }} programadas
        </div>
        </div>
    </div>
    </div>

    <div class="col-sm-6 col-xl-3">
    <div class="card-stat">
        <div class="stat-icon icon-orange">
        <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <div class="stat-info">
        <h3>{{ stats.reportes }}</h3>
        <p>Reportes comunitarios</p>
        <div class="stat-sub">
            <i class="bi bi-circle-fill" style="color:#e02424;font-size:8px"></i>
            {{ stats.reportesAbiertos }} sin resolver
        </div>
        </div>
    </div>
    </div>

</div>

<!-- ── FILA 2: Barras de resumen ──────────────────── -->
<div class="row g-3 mb-4">

    <div class="col-md-6">
    <div class="table-card p-4">
        <h2 class="mb-3" style="font-size:15px;font-weight:700">
        <i class="bi bi-bar-chart-fill me-2" style="color:var(--primary)"></i>
        Resumen de Reportes
        </h2>

        <div class="progress-item">
        <div class="progress-label">
            <span>Abiertos</span>
            <span class="badge-gs1 badge-danger">
            {{ reportesRecientes | countBy: 'estatus' : 'Abierto' }}
            </span>
        </div>
        <div class="progress-bar-gs1">
            <div class="progress-fill danger"
                [style.width.%]="getPorcentaje(
                reportesRecientes | countBy: 'estatus' : 'Abierto',
                reportesRecientes.length || 1
                )">
            </div>
        </div>
        </div>

        <div class="progress-item">
        <div class="progress-label">
            <span>En proceso</span>
            <span class="badge-gs1 badge-warning">
            {{ reportesRecientes | countBy: 'estatus' : 'En proceso' }}
            </span>
        </div>
        <div class="progress-bar-gs1">
            <div class="progress-fill warning"
                [style.width.%]="getPorcentaje(
                reportesRecientes | countBy: 'estatus' : 'En proceso',
                reportesRecientes.length || 1
                )">
            </div>
        </div>
        </div>

        <div class="progress-item">
        <div class="progress-label">
            <span>Resueltos</span>
            <span class="badge-gs1 badge-success">
            {{ reportesRecientes | countBy: 'estatus' : 'Resuelto' }}
            </span>
        </div>
        <div class="progress-bar-gs1">
            <div class="progress-fill success"
                [style.width.%]="getPorcentaje(
                reportesRecientes | countBy: 'estatus' : 'Resuelto',
                reportesRecientes.length || 1
                )">
            </div>
        </div>
        </div>

    </div>
    </div>

    <div class="col-md-6">
    <div class="table-card p-4">
        <h2 class="mb-3" style="font-size:15px;font-weight:700">
        <i class="bi bi-calendar-check-fill me-2" style="color:#7e22ce"></i>
        Estado de Jornadas
        </h2>

        <div class="progress-item">
        <div class="progress-label">
            <span>Programadas</span>
            <span class="badge-gs1 badge-info">{{ stats.jornadasProgramadas }}</span>
        </div>
        <div class="progress-bar-gs1">
            <div class="progress-fill info"
                [style.width.%]="getPorcentaje(stats.jornadasProgramadas, stats.jornadas || 1)">
            </div>
        </div>
        </div>

        <div class="progress-item">
        <div class="progress-label">
            <span>Finalizadas</span>
            <span class="badge-gs1 badge-success">
            {{ jornadasProximas | countBy: 'estatus' : 'Finalizada' }}
            </span>
        </div>
        <div class="progress-bar-gs1">
            <div class="progress-fill success"
                [style.width.%]="getPorcentaje(
                jornadasProximas | countBy: 'estatus' : 'Finalizada',
                stats.jornadas || 1
                )">
            </div>
        </div>
        </div>

        <div class="progress-item">
        <div class="progress-label">
            <span>Canceladas</span>
            <span class="badge-gs1 badge-danger">
            {{ jornadasProximas | countBy: 'estatus' : 'Cancelada' }}
            </span>
        </div>
        <div class="progress-bar-gs1">
            <div class="progress-fill danger"
                [style.width.%]="getPorcentaje(
                jornadasProximas | countBy: 'estatus' : 'Cancelada',
                stats.jornadas || 1
                )">
            </div>
        </div>
        </div>

    </div>
    </div>

</div>

<!-- ── FILA 3: Tablas ─────────────────────────────── -->
<div class="row g-3">

    <!-- Reportes recientes -->
    <div class="col-xl-7">
    <div class="table-card">
        <div class="table-card-header">
        <h2>
            <i class="bi bi-exclamation-triangle-fill me-2" style="color:#c27803"></i>
            Reportes Recientes
        </h2>
        <a routerLink="/reportes" class="btn-ghost">
            Ver todos <i class="bi bi-arrow-right"></i>
        </a>
        </div>

        <div *ngIf="loadingReportes" class="empty-state">
        <i class="bi bi-arrow-repeat"></i>
        <h3>Cargando...</h3>
        </div>

        <div *ngIf="!loadingReportes && reportesRecientes.length === 0" class="empty-state">
        <i class="bi bi-shield-check"></i>
        <h3>Sin reportes</h3>
        <p>No hay incidencias registradas aún</p>
        </div>

        <div *ngIf="!loadingReportes && reportesRecientes.length > 0" class="table-responsive">
        <table class="table">
            <thead>
            <tr>
                <th>Incidencia</th>
                <th>Sector</th>
                <th>Prioridad</th>
                <th>Estatus</th>
                <th>Fecha</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let r of reportesRecientes">
                <td><strong>{{ r.tipo_incidencia }}</strong></td>
                <td>{{ r.sector }}</td>
                <td>
                <span class="badge-gs1" [ngClass]="getPrioridadClass(r.prioridad)">
                    {{ r.prioridad }}
                </span>
                </td>
                <td>
                <span class="badge-gs1" [ngClass]="getEstatusReporteClass(r.estatus)">
                    {{ r.estatus }}
                </span>
                </td>
                <td>{{ r.fecha_creacion | date:'dd/MM/yy' }}</td>
            </tr>
            </tbody>
        </table>
        </div>
    </div>
    </div>

    <!-- Jornadas próximas -->
    <div class="col-xl-5">
    <div class="table-card">
        <div class="table-card-header">
        <h2>
            <i class="bi bi-calendar-event-fill me-2" style="color:#7e22ce"></i>
            Próximas Jornadas
        </h2>
        <a routerLink="/jornadas" class="btn-ghost">
            Ver todas <i class="bi bi-arrow-right"></i>
        </a>
        </div>

        <div *ngIf="loadingJornadas" class="empty-state">
        <i class="bi bi-arrow-repeat"></i>
        <h3>Cargando...</h3>
        </div>

        <div *ngIf="!loadingJornadas && jornadasProximas.length === 0" class="empty-state">
        <i class="bi bi-calendar-x"></i>
        <h3>Sin jornadas programadas</h3>
        </div>

        <div *ngIf="!loadingJornadas && jornadasProximas.length > 0" class="table-responsive">
        <table class="table">
            <thead>
            <tr>
                <th>Evento</th>
                <th>Fecha</th>
                <th>Estatus</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let j of jornadasProximas">
                <td>
                <strong>{{ j.nombre_evento }}</strong>
                <div style="font-size:12px;color:var(--gray-600)">{{ j.sector_lugar ?? '—' }}</div>
                </td>
                <td>{{ j.fecha_inicio | date:'dd/MM/yy' }}</td>
                <td>
                <span class="badge-gs1" [ngClass]="getEstatusJornadaClass(j.estatus)">
                    {{ j.estatus }}
                </span>
                </td>
            </tr>
            </tbody>
        </table>
        </div>
    </div>
    </div>

    <!-- Últimos habitantes -->
    <div class="col-12">
    <div class="table-card">
        <div class="table-card-header">
        <h2>
            <i class="bi bi-people-fill me-2" style="color:var(--primary)"></i>
            Últimos Habitantes Registrados
        </h2>
        <a routerLink="/habitantes" class="btn-ghost">
            Ver todos <i class="bi bi-arrow-right"></i>
        </a>
        </div>

        <div *ngIf="loadingHabitantes" class="empty-state">
        <i class="bi bi-arrow-repeat"></i>
        <h3>Cargando...</h3>
        </div>

        <div *ngIf="!loadingHabitantes && ultimosHabitantes.length === 0" class="empty-state">
        <i class="bi bi-people"></i>
        <h3>Sin habitantes registrados</h3>
        </div>

        <div *ngIf="!loadingHabitantes && ultimosHabitantes.length > 0" class="table-responsive">
        <table class="table">
            <thead>
            <tr>
                <th>Habitante</th>
                <th>Género</th>
                <th>Sector</th>
                <th>Ocupación</th>
                <th>Jefe Familia</th>
                <th>Discapacidad</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let h of ultimosHabitantes">
                <td>
                <div class="d-flex align-items-center gap-2">
                    <div class="avatar" style="width:32px;height:32px;font-size:13px;flex-shrink:0">
                    {{ getInicial(h) }}
                    </div>
                    <div>
                    <strong>{{ getNombreCompleto(h) }}</strong>
                    <div style="font-size:12px;color:var(--gray-600)">{{ h.correo ?? '—' }}</div>
                    </div>
                </div>
                </td>
                <td>{{ h.genero | titlecase }}</td>
                <td>{{ h.direccion?.sector ?? '—' }}</td>
                <td>{{ h.ocupacion ?? '—' }}</td>
                <td>
                <span class="badge-gs1" [ngClass]="h.jefe_familia ? 'badge-success' : 'badge-gray'">
                    {{ h.jefe_familia ? 'Sí' : 'No' }}
                </span>
                </td>
                <td>
                <span class="badge-gs1"
                        [ngClass]="h.discapacidad?.tiene_discapacidad ? 'badge-warning' : 'badge-gray'">
                    {{ h.discapacidad?.tiene_discapacidad ? 'Sí' : 'No' }}
                </span>
                </td>
            </tr>
            </tbody>
        </table>
        </div>
    </div>
    </div>

</div>
</div>